$(function(){function t(t,e){var n=new FileReader;n.addEventListener("load",function(t){e&&e(n.result)}),n.readAsDataURL(t)}function e(e){var n=e.type,a=e.size;acceptType="image/gif, image/jpeg, image/png",acceptType.match(n)?a>41943040?alert("图片大小不能超过40MB"):t(e,function(t){r(t)}):alert("图片格式不对，支持jpg、gif、png")}function n(t){var e=document.getElementById("myForm"),n=new FormData(e),o=encodeURI($.trim($("#userInput").val()));""!==o?(n.append("fileType","1"),$.ajax({type:"post",data:n,url:"http://node.ulibuy.com/api/generateCard/"+o,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){$(".js-loading").show()},complete:function(){},success:function(t){t&&""!=t.file?($(".js-buildImg").attr("src",t.file).on("load",function(){$(".js-modal-layer").fadeOut(300),$(".js-loading").hide(),$(".js-rebuildBtn,.js-shareBtn").show(),$(".js-tmplBtn,.js-uploadBtn").hide()}),a()):alert("网络错误")},error:function(t){alert("网络错误")}})):d("请输入您的寄语")}function a(){wx.onMenuShareTimeline({title:$("meta[property='share-title']").attr("content"),link:$("meta[property='share-link']")?$("meta[property='share-link']").attr("content"):location.href,imgUrl:$(".js-buildImg").attr("src"),cancel:function(){},success:function(){}}),wx.onMenuShareAppMessage({title:$("meta[property='share-title']").attr("content"),desc:$("meta[property='share-desc']").attr("content"),link:$("meta[property='share-link']")?$("meta[property='share-link']").attr("content"):location.href,imgUrl:$(".js-buildImg").attr("src"),type:"",dataUrl:"",cancel:function(){},success:function(){}})}function o(t){var e=t.length,n=t.substring(14,e);$("#templateId").val(n)}function i(){$.ajax({type:"get",url:"http://node.ulibuy.com/api/cardList",data:{pageNo:p++,pageSize:h},dataType:"json",success:function(t){var e=t.data.length;t&&0!==e&&(s(t.data),$(".js-currentNo").fadeIn(500).find("span").html(t.num+100)),0===e&&(m=!1)},error:function(t){alert("网络错误")}})}function s(t){var e="";$.each(t,function(t,n){e+='<div class="item"><img src="'+n+'"></div>'}),$(".js-moreWish-layer").find(".picList").append(e)}function c(t){for(var e="",n=1;n<t;n++)e+='<div class="item"><img src="./images/temp/gan'+n+'.jpg" data-name="gan'+n+'"></div>';$(".js-tmpl-layer .js-picList").html(e)}function r(t){$("#preMyImg").attr("src",t).on("load",function(){$(".modal-layer").hide(),$(".js-modal-layer").fadeIn(500)})}function d(t){var e=$(".js-error-layer");e.find(".tip").html(t),e.fadeIn(500),setTimeout(function(){e.fadeOut(500)},1e3)}function l(){j.load(),j.play()}var u=new Swiper(".swiper-container",{direction:"vertical",loop:!1,effect:"fade",fade:{crossFade:!0},onInit:function(t){swiperAnimateCache(t),swiperAnimate(t)},onTransitionEnd:function(t){swiperAnimate(t),1!==t.activeIndex&&2!==t.activeIndex&&3!==t.activeIndex||u.unlockSwipeToNext(),4===t.activeIndex&&u.lockSwipeToNext(),t.activeIndex>1?$(".js-hand").hide():$(".js-hand").addClass("handUpOut").removeClass("handLeft handLeftOut").show(),2===t.activeIndex&&($(".js-hand").removeClass("handUpOut").addClass("handLeft handLeftOut").show(),u.lockSwipes(),f=4)}}),f=4;!function(){var t,e,n,a,o,i,s,c=document.getElementById("book"),r=$("#book").find("li"),d=function(){f>=1&&(f--,r.eq(f).css({transform:"rotateY(-140deg)",transition:"3s"}),f<1&&(f=0),2===f&&$(".js-hand").hide())};c.addEventListener("touchstart",function(n){clearInterval(void 0),n.preventDefault(),t=n.touches[0].pageX,e=n.touches[0].pageY},!1),c.addEventListener("touchend",function(c){c.preventDefault(),n=c.changedTouches[0].pageX,a=c.changedTouches[0].pageY,o=n-t,i=a-e,Math.abs(o)>Math.abs(i)&&o>0?(1===f&&clearTimeout(s),f<=3&&(r.eq(f).css({transform:"rotateY(0deg)",transition:"3s"}),++f>3&&(f=4))):Math.abs(o)>Math.abs(i)&&o<0?d():Math.abs(i)>Math.abs(o)&&i>0||(Math.abs(i),Math.abs(o)),0===f&&(s=setTimeout(function(){u.unlockSwipes(),u.slideTo(3,1e3,!1)},800))})}(),$(".js-seeOthersBtn").on("click",function(){$(".js-moreWish-layer").fadeIn(500)});var m=!0,p=1,h=8;!function(){var t=$(".js-moreWish-layer"),e=t.find(".picList"),n=t.find(".picBx"),a=e.height(),o=n.height();n.on("scroll",function(){$(this).scrollTop()+o>=a-1&&m&&i()})}(),i();var g=$(".js-zoomImg");$(".js-moreWish-layer").on("click",".item",function(){var t=$(this).find("img").attr("src");g.find("img").attr("src",t),g.fadeIn(500)}),g.on("click",function(t){$(t.target).hasClass("js-zoomImg")&&g.fadeOut(300)}),$(".js-shareBtn").on("click",function(){a(),$(".js-share-layer").fadeIn(500)}),$(".js-share-layer").on("click",function(){$(".js-share-layer").fadeOut(300)}),$("#myImg").on("change",function(t){$("#templateId").val("");var n=t.target.files;n&&e(n[0])}),$(".js-sureBtn").on("click",function(){n()}),$(".js-backBtn").on("click",function(){$(".js-modal-layer").fadeOut(300)}),$(".tmplBtn").on("click",function(){c(13),$(".js-tmpl-layer").fadeIn(500)}),$(".js-goBackBtn").on("click",function(){$(".modal-layer").fadeOut(500)}),$(".js-wishBtn").on("click",function(){u.slideNext(),$(".js-rebuildBtn,.js-shareBtn").hide(),$(".js-tmplBtn,.js-uploadBtn").show()}),$(".js-rebuildBtn").on("click",function(){$(".js-rebuildBtn,.js-shareBtn").hide(),$(".js-tmplBtn,.js-uploadBtn").show()}),$(".js-picList").on("click",".item",function(){var t=$(this).find("img").attr("src");r(t),o(t)});var j=document.getElementById("bgm");j.src="http://game.ulibuy.com/wish/audio/music.mp3?v=1",j.addEventListener("loadstart",function(){console.log("loadstart")},!1),j.addEventListener("loadeddata",function(){console.log("loadeddata")},!1),j.addEventListener("loadedmetadata",function(){console.log("loadedmetadata")},!1),j.addEventListener("canplay",function(){console.log("canplay")},!1),j.addEventListener("play",function(){console.log("play"),window.removeEventListener("touchstart",l,!1)},!1),j.addEventListener("playing",function(){console.log("playing")},!1),j.addEventListener("pause",function(){console.log("pause")},!1),window.addEventListener("touchstart",l,!1),$(window).trigger("touchstart"),$(".musicButton").on("click",function(){document.getElementById("bgm").paused?($(".musicButton").css({"background-image":"url('/wish/images/sound-on.png')"}),document.getElementById("bgm").play()):(document.getElementById("bgm").pause(),$(".musicButton").css({"background-image":"url('/wish/images/sound-off.png')"}))})});